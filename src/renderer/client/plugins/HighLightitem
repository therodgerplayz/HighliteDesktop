import { Plugin, SettingsTypes } from "@highlite/core";

const highlightClass = "hl-ground-highlight";
const styleId = "hl-ground-highlight-style";

export default class GroundItemHighlighter extends Plugin {
  constructor() {
    super();

    this.pluginName = "Ground Item Highlighter";
    this.author = "YourName";

    this.settings.enable = {
      text: "Enable Ground Highlights",
      type: SettingsTypes.checkbox,
      value: false,
      callback: () => this.settings.enable.value ? this.start() : this.stop()
    };

    this.settings.minValue = {
      text: "Minimum Value",
      type: SettingsTypes.number,
      value: 1000,
      callback: () => this.refreshHighlights()
    };

    this.settings.color = {
      text: "Highlight Color",
      type: SettingsTypes.color,
      value: "#ffcc00",
      callback: () => this.setStyles()
    };
  }

  get isEnabled() {
    return this.settings.enable.value ?? false;
  }

  init() {
    this.log("Ground Item Highlighter Loaded");
  }

  start() {
    this.cleanup();
    if (!this.isEnabled) return;

    this.setStyles();
    this.refreshHighlights();

    this.log("Started Ground Item Highlighter");
  }

  stop() {
    this.cleanup();
    this.log("Stopped");
  }

  /* -----------------------------
     GAME HOOKS
  ------------------------------*/

  GroundItemManager_handleItemSpawn(e) {
    if (!this.isEnabled) return;
    this.highlightItem(e?.Item);
  }

  GroundItemManager_handleItemDespawn() {
    if (!this.isEnabled) return;
    this.refreshHighlights();
  }

  /* -----------------------------
     Highlight Logic
  ------------------------------*/

  refreshHighlights() {
    const groundManager = this.gameHooks?.GroundItemManager;
    if (!groundManager) return;

    const allItems = groundManager.Items ?? [];
    allItems.forEach(item => this.highlightItem(item));
  }

  highlightItem(item) {
    if (!item) return;

    const itemValue = this.getItemValue(item);
    if (itemValue < this.settings.minValue.value) return;

    const element = item.getElement?.();
    if (!element) return;

    element.classList.add(highlightClass);
  }

  getItemValue(item) {
    try {
      return item?.Definition?.ShopValue ?? 0;
    } catch {
      return 0;
    }
  }

  /* -----------------------------
     Style Management
  ------------------------------*/

  setStyles() {
    let styleEl = document.getElementById(styleId);

    if (!styleEl) {
      styleEl = document.createElement("style");
      styleEl.id = styleId;
      document.body.appendChild(styleEl);
    }

    styleEl.textContent = `
      .${highlightClass} {
        outline: 2px solid ${this.settings.color.value};
        box-shadow: 0 0 8px ${this.settings.color.value};
        border-radius: 4px;
        transition: all 0.15s ease-in-out;
      }
    `;
  }

  cleanup() {
    // remove style tag
    const styleEl = document.getElementById(styleId);
    if (styleEl) styleEl.remove();

    // remove highlight classes
    document.querySelectorAll("." + highlightClass)
            .forEach(el => el.classList.remove(highlightClass));
  }
}
